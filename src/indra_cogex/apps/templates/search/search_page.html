{% extends "base_form.html" %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/choices.min.css">
    <style>
        .btn-group .btn-outline-secondary {
            color: gray;
            background-color: white;
            border-color: gray;
        }

        .btn-group .btn-outline-secondary:hover,
        .btn-group .btn-outline-secondary:focus {
            color: gray;
            background-color: lightgray;
            border-color: gray;
            box-shadow: none;
        }

        .btn-group .btn-outline-secondary.active-btn {
            color: white;
            background-color: gray;
            border-color: gray;
        }

        .example-text {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }

        .example-text:hover {
            color: #0056b3;
        }

        .mt-4 {
            margin-top: 1.5rem;
        }

        /* Add scrollbar to the dropdown to show all elements */
        .choices__list--dropdown {
            max-height: 300px; /* Adjust the height to your preference */
            overflow-y: auto; /* Enable vertical scrolling */
        }
    </style>
    {{ super() }}
{% endblock %}

{% block container %}
    <div class="card card-body bg-light">
        <h1 class="display-4">Statement Search</h1>
        <p class="lead">Search for statements by specifying agent, relationship types, and roles.</p>

        <form method="POST" id="agent-form">
            <!-- Agent Input -->
            <div class="form-group">
                <label for="agent-name">Agent</label>
                <input type="text" class="form-control" id="agent-name" name="agent_name" placeholder="Enter agent name" required>
            </div>

            <!-- Relationship Type Multiselect -->
            <div class="form-group mt-4">
                <label for="choices-multiple-remove-button">Relationship Types</label>
                <select id="choices-multiple-remove-button" name="rel_types[]" multiple></select>
                <!-- Hidden input to store serialized selected options -->
                <input type="hidden" id="rel-type-hidden" name="rel_type" value="">
            </div>

            <!-- Subject/Object Role Buttons -->
            <div class="form-group mt-4 text-center">
                <label>Agent Role</label>
                <div class="btn-group" role="group" aria-label="Agent Role">
                    <button type="button" class="btn btn-outline-secondary" id="left-arrow" onclick="selectRole('left')">Subject</button>
                    <button type="button" class="btn btn-outline-secondary" id="both-arrow" onclick="selectRole('None')">None</button>
                    <button type="button" class="btn btn-outline-secondary" id="right-arrow" onclick="selectRole('right')">Object</button>
                </div>
                <input type="hidden" id="agent-role" name="agent_role" value="">
                <input type="hidden" id="other-agent-role" name="other_agent_role" value="">
            </div>

            <!-- Optional Other Agent Input -->
            <div class="form-group mt-4" id="other-agent-input-container" style="display: none;">
                <label for="other-agent-name">Other Agent</label>
                <input type="text" class="form-control" id="other-agent-name" name="other_agent" placeholder="Enter other agent name">
            </div>

            <button type="submit" class="btn btn-primary mt-4">Search</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/choices.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stmtTypes = {{ stmt_types_json | safe }};
            const selectElement = document.getElementById('choices-multiple-remove-button');
            const hiddenInput = document.getElementById('rel-type-hidden');

            // Initialize Choices.js
            const choices = new Choices(selectElement, {
                removeItemButton: true,
                searchResultLimit: stmtTypes.length,
                renderChoiceLimit: stmtTypes.length,
            });

            // Add options to Choices.js dynamically
            stmtTypes.forEach(type => {
                choices.setChoices([{ value: type, label: type, selected: false }], 'value', 'label', false);
            });

            // Update the hidden input whenever selections change
            selectElement.addEventListener('change', function () {
                const selectedValues = Array.from(selectElement.selectedOptions).map(option => option.value);
                hiddenInput.value = JSON.stringify(selectedValues); // Store as a JSON string
            });

            // Close the dropdown after selecting an option
            selectElement.addEventListener('choice', function () {
                choices.hideDropdown();
            });
        });

        // Handle role selection
        function selectRole(direction) {
            // Remove active state from all buttons
            document.getElementById('left-arrow').classList.remove('active-btn');
            document.getElementById('both-arrow').classList.remove('active-btn');
            document.getElementById('right-arrow').classList.remove('active-btn');

            // Apply active state to the clicked button
            if (direction === 'left') {
                document.getElementById('left-arrow').classList.add('active-btn');
                document.getElementById('agent-role').value = 'subject';
                document.getElementById('other-agent-role').value = 'object';
                document.getElementById('other-agent-input-container').style.display = 'block';
            } else if (direction === 'right') {
                document.getElementById('right-arrow').classList.add('active-btn');
                document.getElementById('agent-role').value = 'object';
                document.getElementById('other-agent-role').value = 'subject';
                document.getElementById('other-agent-input-container').style.display = 'block';
            } else {
                document.getElementById('both-arrow').classList.add('active-btn');
                document.getElementById('agent-role').value = '';
                document.getElementById('other-agent-role').value = '';
                document.getElementById('other-agent-input-container').style.display = 'none';
            }
        }
    </script>
{% endblock %}