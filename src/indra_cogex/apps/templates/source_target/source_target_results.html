{% extends "base.html" %}

{% block title %}Source-Target Analysis Results{% endblock %}

{% block styles %}
    {{ super() }}
    <link
            href="https://cdn.datatables.net/v/bs4/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-html5-3.0.2/datatables.min.css"
            rel="stylesheet"
    />
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.datatables.net/v/bs4/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-html5-3.0.2/datatables.min.js"></script>
    <script>
        const datatablesConf = {
            pageLength: 10,
            layout: {
                bottomStart: {
                    pageLength: {
                        menu: [10, 25, 50, 75, 100],
                    }
                },
                topStart: {
                    buttons: [
                        {
                            extend: 'csv',
                            text: 'Download full table as CSV',
                            exportOptions: {
                                modifier: {
                                    search: 'none'
                                }
                            }
                        }
                    ]
                }
            }
        };
        $(document).ready(function () {
            $(".datatable").DataTable(datatablesConf);
        });
    </script>
{% endblock %}

{% macro render_table(df, table_id) -%}
    <table class="table table-hover table-striped datatable" id="{{ table_id }}" style="width: 100%;">
        <thead>
        <tr>
            {% for column in df.columns %}
                <th scope="col">{{ column }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in df.values %}
            <tr>
                {% for value in row %}
                    <td>{{ value }}</td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endmacro %}

{% block container %}
    <div class="card card-body bg-light">
        <h1 class="display-3">Source-Target Analysis Results</h1>

        {% if errors %}
            <h2>Errors</h2>
            <ul>
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <div>
            <h3>Query Genes</h3>
            <h4>Source Gene</h4>
            <p>
                <a class="badge badge-primary" href="https://bioregistry.io/hgnc:{{ source_id }}" target="_blank">
                    HGNC:{{ source_id }} ({{ source }})
                </a>
            </p>

            <h4>Target Genes</h4>
            <p>
                {% for hgnc_id, name in target_genes.items() %}
                    <a class="badge badge-info" href="https://bioregistry.io/hgnc:{{ hgnc_id }}" target="_blank">
                        HGNC:{{ hgnc_id }} ({{ name }})
                    </a>
                {% endfor %}
            </p>

            {% if results.statements %}
                <h3>INDRA Statements</h3>
                <p>Direct relationships between source and target genes from the INDRA database:</p>
                <div class="statements-container">
                    {{ results.statements | safe }}
                </div>
            {% endif %}

            {% if results.interaction_plot %}
                <h3>Interaction Types</h3>
                <p>Distribution of different types of interactions found:</p>
                <div class="plot-container">
                    <img src="data:image/png;base64,{{ results.interaction_plot }}"
                         alt="Interaction Types Distribution"
                         class="img-fluid">
                </div>
            {% endif %}

            {% if results.pathways %}
                <h3>Shared Pathways</h3>
                <p>Biological pathways shared between source and target genes:</p>
                {{ render_table(results.pathways, "table-pathways") }}
            {% endif %}

            {% if results.protein_families %}
                <h3>Protein Families</h3>
                <p>Protein family relationships:</p>
                {{ render_table(results.protein_families, "table-families") }}
            {% endif %}

            {% if results.go_terms %}
                <h3>GO Term Analysis</h3>
                <p>Shared Gene Ontology terms between source and target genes:</p>
                {{ render_table(results.go_terms.shared_terms, "table-go") }}
            {% endif %}

            {% if results.upstream %}
                <h3>Upstream Analysis</h3>
                <p>Shared upstream regulatory mechanisms:</p>
                {% if results.upstream.shared_proteins %}
                    <h4>Shared Proteins</h4>
                    <ul>
                    {% for protein in results.upstream.shared_proteins %}
                        <li>{{ protein }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}
                {% if results.upstream.shared_entities %}
                    <h4>Detailed Analysis</h4>
                    {{ render_table(results.upstream.shared_entities, "table-upstream") }}
                {% endif %}
            {% endif %}

            {% if results.analysis_plot %}
                <h3>Statistical Analysis</h3>
                <p>Distribution of p-values and q-values for various analyses:</p>
                <div class="plot-container">
                    <img src="data:image/png;base64,{{ results.analysis_plot }}"
                         alt="Statistical Analysis Plots"
                         class="img-fluid">
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}