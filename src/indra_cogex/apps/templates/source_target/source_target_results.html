{% extends "base.html" %}

{% block title %}Source-Target Analysis Results{% endblock %}

{% block styles %}
    {{ super() }}
    <link href="https://cdn.datatables.net/v/bs4/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-html5-3.0.2/datatables.min.css"
          rel="stylesheet"/>
    <style>
        .datatable-wrapper {
            width: 100%;
            overflow-x: auto;
        }
        .badge {
            margin-right: 0.3rem;
            margin-bottom: 0.3rem;
        }
        /* Fix for potential footer overlap */
        .card-body {
            margin-bottom: 50px;
        }

        .container {
            padding-bottom: 70px;
        }

        html, body {
            position: relative;
            min-height: 100%;
        }

        .plot-container {
            margin-bottom: 20px;
        }

        /* Target gene section styling - improved spacing */
        .gene-title {
            margin-top: 15px;  /* Reduced from 20px */
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Keep spacing between sections */
        .target-gene-section {
            margin-bottom: 15px;  /* Reduced from 25px */
            padding-bottom: 10px; /* Added padding at bottom */
        }

        /* Common database badges at top */
        .common-db-keys {
            margin-bottom: 10px;  /* Reduced from 15px */
            padding: 8px;         /* Reduced from 10px */
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        /* Add separation between statements section and next section */
        .statements-section {
            margin-bottom: 25px;  /* Add margin at bottom of entire statements section */
        }

        /* Hide 'reading' text to reduce vertical space */
        .reading {
            display: none;
        }

        /* Make headers more compact */
        .statements-container h3 {
            margin-bottom: 0.5rem;
        }

        /* Ensure main INDRA Statements heading is visible */
        .statements-section > h3 {
            display: block !important;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
    </style>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.datatables.net/v/bs4/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-html5-3.0.2/datatables.min.js"></script>
    <script>
        // Function to format number display
        function formatNumberColumn(data, type) {
            // For sorting, return the original numeric value
            if (type === 'sort' || type === 'type') {
                return data;
            }

            // If data is a number or can be parsed as one
            if (typeof data === 'number' || (typeof data === 'string' && !isNaN(parseFloat(data)))) {
                var num = parseFloat(data);

                // Format regular numbers normally
                if (num >= 0.001 && num < 1000) {
                    return num.toFixed(4);
                }

                // Format using scientific notation for very small or large numbers
                return num.toExponential(4);
            }
            return data; // Return as is if not a number
        }

        $(document).ready(function () {
            // Initialize DataTables with proper formatting and sorting
            $(".datatable").each(function() {
                var qColumnIndex = -1;

                // Find the q-value column index
                $(this).find('thead th').each(function(index) {
                    var headerText = $(this).text().trim().toLowerCase();
                    if (headerText === 'q' || headerText === 'q-value') {
                        qColumnIndex = index;
                    }
                });

                // Define column definitions for formatting
                var columnDefs = [];
                $(this).find('thead th').each(function(index) {
                    var headerText = $(this).text().trim().toLowerCase();
                    if (headerText === 'p' || headerText === 'q' ||
                        headerText === 'mlp' || headerText === 'mlq' ||
                        headerText === 'p-value' || headerText === 'q-value') {
                        columnDefs.push({
                            targets: index,
                            render: function(data, type, row) {
                                return formatNumberColumn(data, type);
                            }
                        });
                    }
                });

                // Initialize DataTable
                var tableConfig = {
                    pageLength: 10,
                    order: [], // Start with no specific order
                    columnDefs: columnDefs,
                    layout: {
                        bottomStart: {
                            pageLength: {
                                menu: [10, 25, 50, 75, 100],
                            }
                        },
                        topStart: {
                            buttons: [
                                {
                                    extend: 'csv',
                                    text: 'Download full table as CSV',
                                    exportOptions: {
                                        modifier: {
                                            search: 'none'
                                        }
                                    }
                                }
                            ]
                        }
                    }
                };

                // If we found a q-value column, set it as the default sort column (ascending)
                if (qColumnIndex !== -1) {
                    tableConfig.order = [[qColumnIndex, "asc"]];
                }

                $(this).DataTable(tableConfig);
            });

            // Process INDRA Statements to clean up redundancy
            function processStatementsSection() {
                // Clean up statements display
                if ($('.statements-section').length > 0) {
                    // Extract the first database badges section
                    var firstDbSection = $('.statements-section .databases').first().clone();

                    // Move database badges to the top
                    $('#database-badges-container').append(firstDbSection);

                    // Hide all the original database sections
                    $('.statements-section .databases').hide();

                    // Process each gene section
                    $('.statements-section').find('h2:contains("Statements for")').each(function() {
                        // Get the gene name from the heading
                        var geneName = $(this).text().replace('Statements for ', '');

                        // Create a better heading with the expand button to the right
                        var expandButton = $(this).next().find('button').clone();
                        var newHeading = $('<div class="gene-title"></div>');
                        newHeading.append('<h4>' + geneName + '</h4>');
                        newHeading.append(expandButton);

                        // Replace the old heading
                        $(this).after(newHeading);
                        $(this).remove();
                    });

                    // Hide redundant "Statements" headers INSIDE the statements container
                    // but NOT the main "INDRA Statements" heading
                    $('.statements-container h3:contains("Statements")').hide();
                }
            }

            // Call the function after a short delay to ensure all content is loaded
            setTimeout(processStatementsSection, 500);
        });
    </script>
{% endblock %}

{% macro render_table(df, table_id) -%}
    <div class="datatable-wrapper">
        <table class="table table-hover table-striped datatable" id="{{ table_id }}" style="width: 100%;">
            <thead>
            <tr>
                {% for column in df.columns %}
                    <th scope="col">{{ column }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for row in df.values %}
                <tr>
                    {% for value in row %}
                        <td>{{ value }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}

{% block container %}
    <div class="card card-body bg-light">
        <h1 class="display-3">Source-Target Analysis Results</h1>

        {% if errors %}
            <h2>Errors</h2>
            <ul>
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <div>
            <h3>Query Genes</h3>
            <h4>Source Gene</h4>
            <p>
                <a class="badge badge-primary" href="https://bioregistry.io/hgnc:{{ source_id }}" target="_blank">
                    HGNC:{{ source_id }} ({{ source }})
                </a>
            </p>

            <h4>Target Genes</h4>
            <p>
                {% for hgnc_id, name in target_genes.items() %}
                    <a class="badge badge-info" href="https://bioregistry.io/hgnc:{{ hgnc_id }}" target="_blank">
                        HGNC:{{ hgnc_id }} ({{ name }})
                    </a>
                {% endfor %}
            </p>

            {% if results.statements and results.statements.items() %}
                <div class="statements-section">
                    <h3>INDRA Statements</h3>
                    <p>Direct relationships between source and target genes:</p>

                    <!-- Container for database badges -->
                    <div id="database-badges-container" class="common-db-keys"></div>

                    <!-- Statements for each target gene -->
                    <div class="statements-container">
                        {% for gene, statement_html in results.statements.items() %}
                            <div class="target-gene-section">
                                {{ statement_html | safe }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if results.interaction_plot %}
                <h3>Interaction Types</h3>
                <p>Distribution of different types of interactions found:</p>
                <div class="plot-container">
                    <img src="data:image/png;base64,{{ results.interaction_plot }}"
                         alt="Interaction Types Distribution"
                         class="img-fluid">
                </div>
            {% endif %}

            {% if results.protein_families is not none and results.protein_families.shape[0] > 0 %}
                <h3>Protein Families</h3>
                <p>Identifies shared protein family complexes for the target proteins and the source protein.</p>
                {{ render_table(results.protein_families, "table-families") }}
            {% endif %}

            {% if results.combined_pathways is not none and results.combined_pathways.shape[0] > 0 %}
                <h3>Combined Pathway Analysis</h3>
                <p>Shows combined pathway information from REACTOME and WikiPathways for the source and target genes.</p>
                {{ render_table(results.combined_pathways, "table-combined-pathways") }}
            {% endif %}

            {% if results.go_terms and results.go_terms.get('shared_terms') is not none
                  and results.go_terms.get('shared_terms').shape[0] > 0 %}
                <h3>GO Terms Analysis</h3>
                <p>Displays shared Gene Ontology (GO) terms between the source protein and target genes.</p>
                {{ render_table(results.go_terms.get('shared_terms'), "table-shared-go") }}
            {% endif %}

            {% if results.analysis_plot %}
                <h3>Statistical Analysis</h3>
                <p>Distribution of p-values and q-values:</p>
                <div class="plot-container">
                    <img src="data:image/png;base64,{{ results.analysis_plot }}"
                         alt="Statistical Analysis Plots"
                         class="img-fluid">
                </div>
            {% endif %}

            {% if results.upstream and results.upstream.get('shared_proteins') %}
                <h3>Upstream Analysis</h3>
                <p>Shared upstream regulatory mechanisms:</p>
                <h4>Shared Proteins</h4>
                <p>
                {% for protein in results.upstream.get('shared_proteins') %}
                    <span class="badge badge-primary">{{ protein }}</span>
                {% endfor %}
                </p>
            {% endif %}
        </div>
    </div>
    <!-- Add extra space at bottom to prevent footer overlap -->
    <div style="height: 50px;"></div>
{% endblock %}