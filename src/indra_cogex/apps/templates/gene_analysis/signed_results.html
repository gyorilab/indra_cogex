{% extends "base.html" %}

{% block title %}Signed Gene Set Analysis{% endblock %}

{% block styles %}
    {{ super() }}
    <!-- DataTables, see: https://datatables.net/examples/styling/bootstrap4.html-->
    <link
            href="https://cdn.datatables.net/v/bs4/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-html5-3.0.2/datatables.min.css"
            rel="stylesheet"
    />
    <style>
        .info-icon {
            cursor: help;
            color: #6c757d;
            font-size: 0.85em;
            margin-left: 4px;
        }
        .info-icon:hover {
            color: #495057;
        }
        .ranking-explanation {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- DataTables, see: https://datatables.net/examples/styling/bootstrap4.html-->
    <script src="https://cdn.datatables.net/v/bs4/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-html5-3.0.2/datatables.min.js"></script>
    <script>
        const datatablesConf = {
            "order": [[5, "asc"]],  // Sort by p-value (column 5)
            pageLength: 10,
            layout: {
                bottomStart: {
                    pageLength: {
                        menu: [10, 25, 50, 75, 100],
                    }
                },
                topStart: {
                    buttons: [
                        {
                            extend: 'csv',
                            text: 'Download full table as CSV',
                            exportOptions: {
                                modifier: {
                                    search: 'none'
                                }
                            }
                        }
                    ]
                }
            }
        };
        $(document).ready(function () {
            $("#table-rcr").DataTable(datatablesConf);

            // Initialize Bootstrap popovers
            $('[data-toggle="popover"]').popover({
                html: true,
                trigger: 'hover',
                placement: 'top'
            });
        });
    </script>
{% endblock %}

{% macro render_table(df, table_id, positive_genes, negative_genes, minimum_evidence, minimum_belief) -%}
    <p class="ranking-explanation">
        <i class="fas fa-info-circle"></i>
        Results are ranked by statistical significance (p-value). Smaller p-values indicate more significant matches between your gene sets and the database patterns.
    </p>
    <table class="table table-hover table-striped" id="{{ table_id }}" style="width: 100%;">
        <thead>
        <tr>
            <th scope="col">CURIE
                <i class="fas fa-info-circle info-icon"
                   data-toggle="popover"
                   data-placement="top"
                   data-content="<strong>CURIE</strong> (Compact URI) is a standardized identifier. Clicking the link opens the relevant database page (HGNC, HPO, MeSH, etc.) for this entity."></i>
            </th>
            <th scope="col">Name</th>
            <th scope="col">âœ“
                <i class="fas fa-info-circle info-icon"
                   data-toggle="popover"
                   data-placement="top"
                   data-content="<strong>âœ“ (Correct)</strong> shows how many of your positive/negative genes matched the expected pattern for this entity. Positive genes should be activated by this entity, negative genes should be inhibited."></i>
            </th>
            <th scope="col">âœ—
                <i class="fas fa-info-circle info-icon"
                   data-toggle="popover"
                   data-placement="top"
                   data-content="<strong>âœ— (Incorrect)</strong> shows how many of your genes had the opposite pattern. Positive genes were inhibited or negative genes were activated by this entity."></i>
            </th>
            <th scope="col">ðŸ¤·
                <i class="fas fa-info-circle info-icon"
                   data-toggle="popover"
                   data-placement="top"
                   data-content="<strong>ðŸ¤· (Ambiguous)</strong> shows genes with conflicting patterns (both activated and inhibited) or genes with no known relationship to this entity."></i>
            </th>
            <th scope="col"><i>p</i>-value
                <i class="fas fa-info-circle info-icon"
                   data-toggle="popover"
                   data-placement="top"
                   data-content="<strong>p-value</strong> measures statistical significance from a binomial test comparing correct vs incorrect matches. Smaller values (e.g., 1e-10) mean it's very unlikely this pattern of matches happened by random chance. The most significant results (smallest p-values) appear at the top."></i>
            </th>
            <th scope="col">Statements
                <i class="fas fa-info-circle info-icon"
                   data-toggle="popover"
                   data-placement="top"
                   data-content="<strong>Statements</strong> are INDRA causal relationships connecting your input genes to this regulator. Click 'View Statements' to see the detailed evidence."></i>
            </th>
        </tr>
        </thead>
        <tbody>
        {% for curie, name, correct, incorrect, ambig, p, conservative_p, statements in df.values %}
            {% set pos_gene_list = [] %}
            {% set neg_gene_list = [] %}
            {% for gene_id in positive_genes.keys() %}
                {% do pos_gene_list.append("HGNC:" + gene_id) %}
            {% endfor %}
            {% for gene_id in negative_genes.keys() %}
                {% do neg_gene_list.append("HGNC:" + gene_id) %}
            {% endfor %}
            <tr class="clickable-row"
               data-statements='{{ statements | tojson }}'
               data-regulator-name="{{ name | e }}">
                <td><a href="https://bioregistry.io/{{ curie }}" target="_blank">{{ curie }}</a></td>
                <td>{{ name }}</td>
                <td>{{ correct }}</td>
                <td>{{ incorrect }}</td>
                <td>{{ ambig }}</td>
                <td>{{ "{:.2e}".format(p) }}</td>
                <td>
                    <a href="{{ url_for('search.search_signed_statements',
                        target_id=curie,
                        positive_genes=pos_gene_list,
                        negative_genes=neg_gene_list,
                        minimum_evidence=minimum_evidence,
                        minimum_belief=minimum_belief) }}"
                        target="_blank"
                        class="btn btn-primary btn-sm">View Statements</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endmacro %}

{% block container %}
    <div class="card card-body bg-light">
        <h1 class="display-3">Signed Gene Set Analysis</h1>
        <div>
            {% if positive_errors %}
                <h2>Positive Errors</h2>
                <ul>
                    {% for error in positive_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <h3>Positive Query</h3>
            <p>
                {% for hgnc_id, name in positive_genes.items() %}
                    <a class="badge badge-info" href="https://bioregistry.io/hgnc:{{ hgnc_id }}" target="_blank">HGNC:{{ hgnc_id }}
                        ({{ name }})</a>
                {% endfor %}
            </p>
            {% if negative_errors %}
                <h2>Negative Errors</h2>
                <ul>
                    {% for error in negative_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <h3>Negative Query</h3>
            <p>
                {% for hgnc_id, name in negative_genes.items() %}
                    <a class="badge badge-warning" href="https://bioregistry.io/hgnc:{{ hgnc_id }}" target="_blank">HGNC:{{ hgnc_id }}
                        ({{ name }})</a>
                {% endfor %}
            </p>
            <h3>Reverse Causal Reasoning Analysis</h3>
            <div>
                <p>
                    These results are acquired by running
                    <a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-14-340">Reverse
                        Causal Reasoning</a> analysis, which compares the activated/up-regulated and
                    inhibited/down-regulated genes for each entity in the INDRA database with a positive and negative
                    query gene set. A <i>p</i>-value is calculated by applying a binomial test to the matches and
                    non-matches.
                </p>
                {{ render_table(results, "table-rcr", positive_genes, negative_genes, minimum_evidence, minimum_belief) }}
            </div>
        </div>
    </div>
{% include 'gene_analysis/metadata_preview.html' %}
{% endblock %}